var B=m=>{throw TypeError(m)};var R=(m,T,C)=>T.has(m)||B("Cannot "+C);var d=(m,T,C)=>(R(m,T,"read from private field"),C?C.call(m):T.get(m)),b=(m,T,C)=>T.has(m)?B("Cannot add the same private member more than once"):T instanceof WeakSet?T.add(m):T.set(m,C),v=(m,T,C,x)=>(R(m,T,"write to private field"),x?x.call(m,C):T.set(m,C),C),w=(m,T,C)=>(R(m,T,"access private method"),C);(function(){"use strict";var D,K,U,E,_,$,I,f,A,L,M,z,Q;let m,T,C=!1;function x(){const e=document.querySelector(".task-wrapper").clientHeight,t=document.querySelector(".task-container.primary"),s=t.scrollHeight,r=document.querySelector(".task-container.secondary");if(s>e&&!C){r.style.display="flex";const n=configs.settings.scrollSpeed.toString();let a=parseInt(n,10),c={duration:s/a*1e3,iterations:1,easing:"linear"};const y=getComputedStyle(document.documentElement).getPropertyValue("--card-gap-between").slice(0,-2);let S=s+parseInt(y,10),l=[{transform:"translateY(0)"},{transform:`translateY(-${S}px)`}],g=[{transform:"translateY(0)"},{transform:`translateY(-${S}px)`}];m=t.animate(l,c),T=r.animate(g,c),C=!0,X()}else s<=e&&(r.style.display="none",Z())}function Z(){m&&m.cancel(),T&&T.cancel(),C=!1}function X(){m&&(m.addEventListener("finish",H),m.addEventListener("cancel",H))}function H(){C=!1,x()}function F(o,e){o.innerText!==e&&(o.style.opacity="0",setTimeout(()=>{o.textContent=e,o.style.opacity="1"},700))}function ee(o){const e=document.querySelector(":root");for(let[t,s]of Object.entries(o))t.includes("FontFamily")&&te(s),e.style.setProperty(se(t),s)}function te(o){WebFont.load({google:{families:[`${o}:100,400,700`]}})}function se(o){return`--${o.replace(/([A-Z])/g,"-$1").toLowerCase()}`}class G{constructor(e,t){this.username=this.validateUsername(e),this.userColor=(t==null?void 0:t.userColor)||"",this.tasks=[]}validateUsername(e){if(typeof e!="string")throw new Error("Username must be of type string");if(e=e.trim(),e.length===0)throw new Error("Username invalid");return e}addTask(e){return this.tasks.push(e),e}editTask(e,t){let s=this.getTask(e);return s?(s.setDescription(t),s):null}completeTask(e){let t=this.getTask(e);return t?(t.setCompletionStatus(!0),t):null}deleteTask(e){const t=[].concat(e).filter(r=>this.validTaskIndex(r)),s=[];return this.tasks=this.tasks.filter((r,n)=>t.includes(n)?(s.push(r),!1):!0),s}removeCompletedTasks(){const e=[];return this.tasks=this.tasks.filter(t=>t.isComplete()?(e.push(t),!1):!0),e}getTask(e){return this.validTaskIndex(e)?this.tasks[e]:null}getTasks(){return this.tasks}validTaskIndex(e){return!(typeof e!="number"||isNaN(e)||e<0||e>=this.tasks.length)}}class V{constructor(e){b(this,D);this.description=this.validateDescription(e),this.id=w(this,D,K).call(this),this.completionStatus=!1}validateDescription(e){if(typeof e!="string")throw new Error("Task description must be of type string");if(e=e.trim(),e.length===0)throw new Error("Task description invalid");return e}setDescription(e){this.description=this.validateDescription(e)}isComplete(){return this.completionStatus}setCompletionStatus(e){if(typeof e!="boolean")throw new Error("Completion status must be of type boolean");this.completionStatus=e}}D=new WeakSet,K=function(){const e=new Date,t=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0"),n=String(e.getSeconds()).padStart(2,"0"),a=String(e.getMilliseconds()).padStart(3,"0"),i=Math.floor(Math.random()*1e4);return`${t}${s}${r}${n}${a}${i}`};class re{constructor(e="userList"){b(this,E);b(this,U);v(this,U,e),this.tasksCompleted=0,this.totalTasks=0,this.users=w(this,E,_).call(this)}getUser(e){return this.users.find(t=>t.username===e)}getAllUsers(){return this.users}createUser(e,t){if(this.getUser(e))throw new Error(`${e} already exists`);const s=new G(e,t);return this.users.push(s),s}addUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`${e} does not exist`);const r=[].concat(t),n=[];return r.forEach(a=>{n.push(s.addTask(new V(a))),this.totalTasks++}),w(this,E,$).call(this),n}editUserTask(e,t,s){const r=this.getUser(e);if(!r)throw new Error(`${e} has no tasks`);const n=r.editTask(t,s);if(!n)throw new Error(`Task ${t} not found`);return w(this,E,$).call(this),n}completeUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`User ${e} not found`);const r=[].concat(t).reduce((n,a)=>{const i=s.getTask(a);return i&&(i.isComplete()||(i.setCompletionStatus(!0),this.tasksCompleted++),n.push(i)),n},[]);return w(this,E,$).call(this),r}deleteUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`User ${e} not found`);const r=[].concat(t),n=s.deleteTask(r);return s.getTasks().length===0&&this.deleteUser(e),this.decreaseTaskCount(n),w(this,E,$).call(this),n}checkUserTasks(e,t="incomplete"){const s=this.getUser(e);if(!s)return new Map;const r=new Map;return s.getTasks().forEach((n,a)=>{t==="incomplete"&&!n.isComplete()&&r.set(a,n),t==="complete"&&n.isComplete()&&r.set(a,n)}),r}clearUserList(){this.users=[],this.tasksCompleted=0,this.totalTasks=0,w(this,E,$).call(this)}clearDoneTasks(){let e=[];return this.users.forEach(t=>{let s=t.removeCompletedTasks();this.decreaseTaskCount(s),e=e.concat(s)}),w(this,E,$).call(this),e}deleteUser(e){const t=this.users.findIndex(n=>n.username.toLowerCase()===e.toLowerCase());if(t===-1)throw new Error(`${e} not found`);const s=this.users[t],r=this.users.splice(t,1)[0];return this.decreaseTaskCount(r.getTasks()),w(this,E,$).call(this),s}decreaseTaskCount(e){e.forEach(t=>{t.isComplete()&&this.tasksCompleted--,this.totalTasks--})}}U=new WeakMap,E=new WeakSet,_=function(){const e=[];let t=localStorage.getItem(d(this,U));return t?JSON.parse(t).forEach(s=>{const r=new G(s.username,{userColor:s.userColor});s.tasks.map(n=>{const a=r.addTask(new V(n.description));this.totalTasks++,n.completionStatus&&(a.setCompletionStatus(n.completionStatus),this.tasksCompleted++)}),e.push(r)}):localStorage.setItem(d(this,U),JSON.stringify(e)),e},$=function(){localStorage.setItem(d(this,U),JSON.stringify(this.users))};const ne=document.getElementById("audioSample");class oe{constructor(e){b(this,I,null);this.userList=new re(e),ee(configs.styles)}render(){this.renderTaskList(),this.renderTaskHeader()}renderTaskList(){if(this.userList.users.length===0)return;const e=document.createDocumentFragment();this.userList.getAllUsers().forEach(a=>{const i=J(a),c=i.querySelector("ol");a.tasks.forEach(y=>{const S=document.createElement("li");S.classList.add("task"),S.dataset.taskId=`${y.id}`,S.innerText=y.description,y.isComplete()&&S.classList.add("done"),c.appendChild(S)}),e.appendChild(i)});const t=e.cloneNode(!0),s=document.querySelector(".task-container.primary");s.innerHTML="",s.appendChild(t);const r=e.cloneNode(!0),n=document.querySelector(".task-container.secondary");n.innerHTML="",n.appendChild(r),x()}renderTaskHeader(){this.renderTaskCount();const{headerFeature:e,headerCustomText:t}=configs.settings;e.toLowerCase()==="timer"?this.renderTimer():e.toLowerCase()==="commands"?this.renderCommandTips():e.toLowerCase()==="text"&&this.renderCustomText(t)}renderTaskCount(){let e=this.userList.tasksCompleted,t=this.userList.totalTasks;const s=document.querySelector(".task-count");s.innerText=`${e}/${t}`}renderTimer(){document.querySelector(".timer").classList.remove("hidden")}startTimer(e=0,t=10){d(this,I)&&clearInterval(d(this,I));const s=document.querySelector(".timer"),r=s.querySelector(".timer-title"),n=s.querySelector(".timer-countdown");let a=e*60;F(r,"Focus");let i=!0;const c=()=>{const y=Math.floor(a/60).toString().padStart(2,"0"),S=(a%60).toString().padStart(2,"0");n.textContent=`${y}:${S}`,a===0?(clearInterval(d(this,I)),F(r,"Break"),n.textContent="00:00",ne.play(),a=t*60,i&&(v(this,I,setInterval(c,1e3)),i=!1)):a--};v(this,I,setInterval(c,1e3))}renderCommandTips(){const e=["!task","!edit","!done","!remove","!check","!help"],t=document.querySelector(".command-tips");t.classList.remove("hidden");let s=0;setInterval(()=>{const r=t.querySelector(".command-code");F(r,e[s]),s=(s+1)%e.length},6e3)}renderCustomText(e){document.querySelector(".custom-header").classList.remove("hidden"),document.querySelector(".custom-text").textContent=e}chatHandler(e,t,s,r,n){t=`!${t.toLowerCase()}`;const{admin:a,user:i,settings:{languageCode:c,maxTasksPerUser:y,headerFeature:S}}=configs;let l="",g="";try{if(ae(r))if(S.toLowerCase()==="timer"&&a.commands.timer.includes(t)&&r.broadcaster){const[h,p]=s.split("/"),u=parseInt(h,10),k=parseInt(p,10)||10;if(isNaN(u)||u<0||isNaN(k)||k<0)throw new Error("Invalid timer duration");return this.startTimer(u,k),l=a.responseTo[c].timer,g=h,O(l,e,g)}else{if(a.commands.clearList.includes(t))return this.userList.clearUserList(),this.clearListFromDOM(),l=a.responseTo[c].clearList,O(l,e,g);if(a.commands.clearDone.includes(t))return this.userList.clearDoneTasks().forEach(({id:p})=>{this.deleteTaskFromDOM(p)}),l=a.responseTo[c].clearDone,O(l,e,g);if(a.commands.clearUser.includes(t)){const h=this.userList.deleteUser(s);return this.deleteUserFromDOM(h),g=h.username,l=a.responseTo[c].clearUser,O(l,e,g)}}if(i.commands.addTask.includes(t)){if(s==="")throw new Error("Task description is empty");let h=this.userList.getUser(e)||this.userList.createUser(e,{userColor:n.userColor});const p=s.split(", ");h.getTasks().length+p.length>parseInt(y.toString(),10)?l=i.responseTo[c].maxTasksAdded:(this.userList.addUserTasks(e,p).forEach(k=>{this.addTaskToDOM(h,k)}),g=s,l=i.responseTo[c].addTask)}else if(i.commands.editTask.includes(t)){const h=s.search(new RegExp("(?<=\\d)\\s"));if(h===-1)throw new Error("Task number or description format is invalid");const p=s.slice(0,h),u=s.slice(h+1),k=this.userList.editUserTask(e,P(p),u);this.editTaskFromDOM(k),g=p,l=i.responseTo[c].editTask}else if(i.commands.finishTask.includes(t)){const h=s.split(",").reduce((u,k)=>(P(k)>=0&&u.push(P(k)),u),[]),p=this.userList.completeUserTasks(e,h);p.forEach(({id:u})=>{this.completeTaskFromDOM(u)}),p.length===0?l=i.responseTo[c].noTaskFound:(g=p.reduce((u,k,j,Y)=>{let Ce=j===Y.length-1?k.description:j===Y.length-2?`${k.description}, & `:`${k.description}, `;return u=u.concat(Ce),u},""),l=i.responseTo[c].finishTask)}else if(i.commands.deleteTask.includes(t))if(g=s,s.toLowerCase()==="all"){const h=this.userList.deleteUser(e);this.deleteUserFromDOM(h),l=i.responseTo[c].deleteAll}else{const h=s.split(",").reduce((u,k)=>(P(k)>=0&&u.push(P(k)),u),[]),p=this.userList.deleteUserTasks(e,h);p.forEach(({id:u})=>{this.deleteTaskFromDOM(u)}),p.length===0?l=i.responseTo[c].noTaskFound:l=i.responseTo[c].deleteTask}else if(i.commands.check.includes(t)){const h=this.userList.checkUserTasks(e),p=[];for(let[u,k]of h)p.push(`${u+1}. ${k.description}`);g=p.join(" | "),g===""?l=i.responseTo[c].noTaskFound:l=i.responseTo[c].check}else if(i.commands.help.includes(t))l=i.responseTo[c].help;else if(i.commands.additional.includes(t))l=i.responseTo[c].additional;else throw new Error("command not found");return O(l,e,g)}catch(h){return O(i.responseTo[c].invalidCommand,e,h.message,!0)}}clearListFromDOM(){const e=document.querySelector(".task-container.primary"),t=document.querySelector(".task-container.secondary");e.innerHTML="",t.innerHTML="",this.renderTaskCount()}addTaskToDOM(e,t){const s=document.querySelector(".task-container.primary"),r=document.querySelector(".task-container.secondary");if(document.querySelectorAll(`[data-user="${e.username}"]`).length===0){const c=J(e),y=c.cloneNode(!0);s.appendChild(c),r.appendChild(y)}const a=document.createElement("li");a.classList.add("task"),a.dataset.taskId=`${t.id}`,a.innerText=t.description;const i=a.cloneNode(!0);s.querySelector(`[data-user="${e.username}"] .tasks`).appendChild(a),r.querySelector(`[data-user="${e.username}"] .tasks`).appendChild(i),this.renderTaskCount(),x()}editTaskFromDOM(e){const t=document.querySelectorAll(`[data-task-id="${e.id}"]`);for(const s of t)s.innerText=e.description}completeTaskFromDOM(e){const t=document.querySelectorAll(`[data-task-id="${e}"]`);for(const s of t)s.classList.add("done");this.renderTaskCount()}deleteTaskFromDOM(e){const t=document.querySelectorAll(`[data-task-id="${e}"]`);for(const s of t)s.parentElement.children.length===1?s.parentElement.parentElement.remove():s.remove();this.renderTaskCount()}deleteUserFromDOM(e){const{username:t,tasks:s}=e,r=document.querySelectorAll(`[data-user="${t}"]`);for(let n of r)n.remove();this.renderTaskCount()}}I=new WeakMap;function O(o,e,t,s=!1){return{message:o.replace("{user}",e).replace("{message}",t),error:s}}function ae(o){return o.broadcaster||o.mod}function P(o){return parseInt(o,10)-1}function J({username:o,userColor:e}){const t=document.createElement("div");t.classList.add("card"),t.dataset.user=o;const s=document.createElement("div");s.classList.add("username"),s.innerText=o,s.style.color=configs.settings.showUsernameColor?e:"",t.appendChild(s);const r=document.createElement("ol");return r.classList.add("tasks"),t.appendChild(r),t}function ie(o){const e={command:null,parameters:null,source:null,tags:null};let t=0,s=null,r=null,n=null,a=null;if(o[t]==="@"){let c=o.indexOf(" ");s=o.slice(1,c),t=c+1}if(o[t]===":"){t+=1;let c=o.indexOf(" ",t);r=o.slice(t,c),t=c+1}let i=o.indexOf(":",t);return i===-1&&(i=o.length),n=o.slice(t,i).trim(),i!==o.length&&(t=i+1,a=o.slice(t)),e.command=ce(n),e.command===null?null:(s!==null&&(e.tags=le(s)),e.source=de(r),e.parameters=a,a&&a[0]==="!"&&(e.command=ue(a,e.command)),e)}function ce(o){let e=null;const t=o.split(" ");switch(t[0]){case"JOIN":case"PART":case"NOTICE":case"CLEARCHAT":case"HOSTTARGET":case"PRIVMSG":e={command:t[0],channel:t[1]};break;case"PING":e={command:t[0]};break;case"CAP":e={command:t[0],isCapRequestEnabled:t[2]==="ACK"};break;case"GLOBALUSERSTATE":e={command:t[0]};break;case"USERSTATE":case"ROOMSTATE":e={command:t[0],channel:t[1]};break;case"RECONNECT":e={command:t[0]};break;case"421":return console.error(`Unsupported IRC command: ${t[2]}`),null;case"001":e={command:t[0]};break;case"002":case"003":case"004":case"353":case"366":case"372":case"375":case"376":return null;default:return console.log(`Unexpected command: ${t[0]}`),null}return e}function le(o){const e={"client-nonce":null,flags:null};let t={};return o.split(";").forEach(r=>{let n=r.split("="),a=n[1]===""?null:n[1];switch(n[0]){case"badges":case"badge-info":if(a){let c={};a.split(",").forEach(S=>{let l=S.split("/");c[l[0]]=l[1]}),t[n[0]]=c}else t[n[0]]=null;break;case"emotes":if(a){let c={};a.split("/").forEach(S=>{let l=S.split(":"),g=[];l[1].split(",").forEach(p=>{let u=p.split("-");g.push({startPosition:u[0],endPosition:u[1]})}),c[l[0]]=g}),t[n[0]]=c}else t[n[0]]=null;break;case"emote-sets":let i=a.split(",");t[n[0]]=i;break;default:e.hasOwnProperty(n[0])||(t[n[0]]=a)}}),t}function de(o){if(o==null)return null;{let e=o.split("!");return{nick:e.length==2?e[0]:null,host:e.length==2?e[1]:e[0]}}}function ue(o,e){let s=o.slice(0+1).trim(),r=s.indexOf(" ");return r===-1?(e.botCommand=s.slice(0),e.botCommandParams=""):(e.botCommand=s.slice(0,r),e.botCommandParams=s.slice(r).trim()),e}class me{constructor(){this.events=new Map}on(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}emit(e,...t){this.events.has(e)&&this.events.get(e).forEach(s=>s(...t))}off(e,t){if(this.events.has(e)){const s=this.events.get(e),r=s.indexOf(t);r!==-1&&(s.splice(r,1),s.length===0&&this.events.delete(e))}}once(e,t){const s=(...r)=>{t(...r),this.off(e,s)};this.on(e,s)}}class he extends me{constructor({username:t,authToken:s,channel:r}){super();b(this,M);b(this,f,null);b(this,A,{0:"CONNECTING",1:"OPEN",2:"CLOSING",3:"CLOSED"});b(this,L,0);this.username=t.toLowerCase(),this.channel=`#${r.toLowerCase()}`,this.authToken=s}connect(t="ws://irc-ws.chat.twitch.tv:80"){v(this,f,new WebSocket(t)),d(this,f).onopen=()=>{console.log("Authenticating with Twitch IRC server..."),d(this,f).send("CAP REQ :twitch.tv/tags twitch.tv/commands"),d(this,f).send(`PASS ${this.authToken}`),d(this,f).send(`NICK ${this.username}`)},d(this,f).onerror=s=>(console.error("An error occurred while attempting to establish a WebSocket connect",s),s),d(this,f).onmessage=s=>{w(this,M,z).call(this,s.data)},d(this,f).onclose=s=>{switch(s.code){case 1e3:console.log("Connection closed normally.");break;case 1006:console.error(`Connection dropped. Reconnecting in ${d(this,L)} milliseconds...`);let r=d(this,L);setTimeout(()=>{this.connect()},r),v(this,L,d(this,L)===0?1e3:d(this,L)*2);break;case 1012:console.log("Switching  servers..."),this.connect();break;default:console.error(`Unhandled code: ${s.code}. Reason: ${s.reason}`)}}}say(t,s){if(d(this,f).readyState===WebSocket.OPEN){const n=[s?`@reply-parent-msg-id=${s}`:"","PRIVMSG",this.channel,`:${t}`].join(" ").trim();d(this,f).send(n)}else console.error("Connection is not open")}disconnect(t=1e3,s=""){w(this,M,Q).call(this)==="OPEN"&&d(this,f).close(t,s)}}f=new WeakMap,A=new WeakMap,L=new WeakMap,M=new WeakSet,z=function(t){t.trim().split(`\r
`).forEach(r=>{const n=ie(r);if(n)switch(n.command.command){case"PRIVMSG":if(n.parameters.startsWith("!")){const a=pe(n);this.emit("command",a)}break;case"PING":d(this,f).send("PONG "+n.parameters);break;case"001":d(this,f).send(`JOIN ${this.channel}`);break;case"JOIN":console.log(`Joined ${this.channel}`),v(this,L,0);break;case"RECONNECT":this.disconnect(1012,"The Twitch IRC server is terminating the connection for maintenance reasons.");break;case"PART":console.error("The channel must have banned (/ban) the bot."),d(this,f).close();break;case"NOTICE":n.parameters==="Login authentication failed"?(console.error(`Authentication failed; left #${this.channel}`),d(this,f).send(`PART ${this.channel}`)):n.parameters==="You don't have permission to perform that action"&&(console.error(`No permission. Check if the access token is still valid. Left ${this.channel}`),d(this,f).send(`PART ${this.channel}`));break}})},Q=function(){return d(this,A)[d(this,f).readyState]};function pe(o){var e,t;return{user:o.tags["display-name"],command:o.command.botCommand,message:o.command.botCommandParams||"",flags:{broadcaster:!!((e=o.tags.badges)!=null&&e.broadcaster),mod:!!((t=o.tags.badges)!=null&&t.moderator)},extra:{userColor:o.tags.color,messageId:o.tags.id}}}function fe(o){o.emit("command",{user:"adminUser",command:"clearList",message:"",flags:{broadcaster:!0,mod:!1},extra:{userColor:"#FF0000",messageId:`${q()}`}});const e=["red","coral","springGreen","lightSeaGreen","slateBlue","hotpink","violet","orange","darkTurquoise","dodgerblue","blueviolet"],{maxTasksPerUser:t}=configs.settings;for(let s=1;s<=8;s++){const r=`Username${s}`,n=e[s-1];for(let a=0;a<t;a++){const i={user:r,command:"task",message:`test task description ${a===2?"longer text example":""}`,flags:{broadcaster:!0,mod:!1},extra:{userColor:n,messageId:`${q()}`}};setTimeout(()=>{o.emit("command",i)},1e3*s+a*100)}setTimeout(()=>{const a={user:r,command:"done",message:"1",flags:{broadcaster:!0,mod:!1},extra:{userColor:n,messageId:`${q()}`}};o.emit("command",a)},1e3*s+1e4)}}function q(){return`${Math.floor(Math.random()*1e9)}`}const{auth:{twitch_channel:ke,twitch_oauth:Te,twitch_username:ge},settings:{testMode:W}}=configs,N=new he({username:ge,authToken:Te,channel:ke});window.addEventListener("load",()=>{let o="userList";W&&(console.log("Test mode enabled"),o="testUserList");const e=new oe(o);e.render(),N.on("command",t=>{const{user:s,command:r,message:n,flags:a,extra:i}=t,c=e.chatHandler(s,r,n,a,i);c.error?console.error(c.message):N.say(c.message,i.messageId)}),N.connect(),W&&fe(N)})})();
