var A=(h,p,k)=>{if(!p.has(h))throw TypeError("Cannot "+k)};var m=(h,p,k)=>(A(h,p,"read from private field"),k?k.call(h):p.get(h)),b=(h,p,k)=>{if(p.has(h))throw TypeError("Cannot add the same private member more than once");p instanceof WeakSet?p.add(h):p.set(h,k)},O=(h,p,k,I)=>(A(h,p,"write to private field"),I?I.call(h,k):p.set(h,k),k);var g=(h,p,k)=>(A(h,p,"access private method"),k);(function(){"use strict";var x,F,E,v,N,w,y,u,P,q;let h,p;function k(){const e=document.querySelector(".task-wrapper").clientHeight,t=document.querySelector(".task-container.primary"),s=t.scrollHeight,n=document.querySelector(".task-container.secondary");if(s<e)n.style.display="none",I();else{n.style.display="flex";const o=configs.settings.scrollSpeed;let a=parseInt(o,10),c={duration:s/a*1e3,iterations:1,easing:"linear"};const S=getComputedStyle(document.documentElement).getPropertyValue("--card-gap-between").slice(0,-2);let d=s+parseInt(S,10),l=[{transform:"translateY(0)"},{transform:`translateY(-${d}px)`}],f=[{transform:"translateY(0)"},{transform:`translateY(-${d}px)`}];h=t.animate(l,c),p=n.animate(f,c),H()}}function I(){h&&h.cancel(),p&&p.cancel()}function H(){h&&(h.addEventListener("finish",R),h.addEventListener("cancel",R))}function R(){k()}function G(){const r=["!add","!edit","!done","!delete","!taskhelp"],e=document.querySelector(".command-code");let t=0;setInterval(()=>{e.style.opacity=0,setTimeout(()=>{e.innerText=r[t],e.style.opacity=1,t=(t+1)%r.length},1e3)},7e3)}function V(){const r=document.querySelector(":root");for(let[e,t]of Object.entries(configs.styles))e.includes("FontFamily")&&J(t),r.style.setProperty(j(e),t)}function J(r){WebFont.load({google:{families:[`${r}:100,400,700`]}})}function j(r){return`--${r.replace(/([A-Z])/g,"-$1").toLowerCase()}`}class M{constructor(e,t){this.username=this.validateUsername(e),this.userColor=(t==null?void 0:t.userColor)||"",this.tasks=[]}validateUsername(e){if(typeof e!="string")throw new Error("Username must be of type string");if(e=e.trim(),e.length===0)throw new Error("Username invalid");return e}addTask(e){return this.tasks.push(e),e}editTask(e,t){let s=this.getTask(e);return s.setDescription(t),s}completeTask(e){let t=this.getTask(e);return t.setCompletionStatus(!0),t}deleteTask(e){const t=[].concat(e);t.forEach(n=>this.validateTaskIndex(n));const s=[];return this.tasks=this.tasks.filter((n,o)=>{if(t.includes(o))s.push(n);else return!0}),s}clearDoneTasks(){return this.tasks=this.tasks.filter(e=>!e.isComplete()),this.tasks}getTask(e){return this.validateTaskIndex(e),this.tasks[e]}getTasks(){return this.tasks}validateTaskIndex(e){if(typeof e!="number"||isNaN(e))throw new Error("Task index must be a number");if(e<0||e>=this.tasks.length)throw new Error("Task index out of bounds");return!0}}class ${constructor(e){b(this,x);this.description=this.validateDescription(e),this.id=g(this,x,F).call(this),this.completionStatus=!1}validateDescription(e){if(typeof e!="string")throw new Error("Task description must be of type string");if(e=e.trim(),e.length===0)throw new Error("Task description invalid");return e}setDescription(e){this.description=this.validateDescription(e)}isComplete(){return this.completionStatus}setCompletionStatus(e){if(typeof e!="boolean")throw new Error("Completion status must be of type boolean");this.completionStatus=e}}x=new WeakSet,F=function(){const e=new Date,t=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0"),i=Math.floor(Math.random()*1e4);return`${t}${s}${n}${o}${a}${i}`};class W{constructor(e="userList"){b(this,v);b(this,w);b(this,E,void 0);O(this,E,e),window.configs.settings.testMode&&O(this,E,"testUserList"),this.users=g(this,v,N).call(this)}getUser(e){return this.users.find(s=>s.username===e)}getAllUsers(){return this.users}createUser(e,t){if(this.getUser(e))throw new Error(`${e} already exists`);const s=new M(e,t);return this.users.push(s),s}addUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`${e} does not exist`);const n=[].concat(t),o=[];return n.forEach(a=>{o.push(s.addTask(new $(a)))}),g(this,w,y).call(this),o}editUserTask(e,t,s){const n=this.getUser(e);if(!n)throw new Error(`${e} has no tasks`);const o=n.editTask(t,s);return g(this,w,y).call(this),o}completeUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`${e} has no tasks`);const o=[].concat(t).map(a=>s.completeTask(a));return g(this,w,y).call(this),o}deleteUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`${e} has no tasks`);const n=[].concat(t),o=s.deleteTask(n);return g(this,w,y).call(this),o}checkUserTasks(e){const t=this.getUser(e);if(!t)throw new Error(`${e} has no tasks`);return t.getTasks().filter(s=>!s.isComplete()).map(s=>s.description)}clearUserList(){this.users=[],g(this,w,y).call(this)}clearDoneTasks(){const e=[];return this.users.forEach(t=>{e.concat(t.clearDoneTasks())}),g(this,w,y).call(this),e}deleteUser(e){const t=this.users.findIndex(n=>n.username===e);if(t===-1)throw new Error(`${e} not found`);const s=this.users[t];return this.users.splice(t,1),g(this,w,y).call(this),s}}E=new WeakMap,v=new WeakSet,N=function(){let e=localStorage.getItem(m(this,E));return e?(e=JSON.parse(e),e.map(t=>{const s=new M(t.username,{userColor:t.userColor});return t.tasks.map(n=>{const o=s.addTask(new $(n.description,n.id));n.completionStatus&&o.setCompletionStatus(n.completionStatus)}),s})):(e=[],window.configs.settings.testMode&&(e=Y()),localStorage.setItem(m(this,E),JSON.stringify(e)),e)},w=new WeakSet,y=function(){localStorage.setItem(m(this,E),JSON.stringify(this.users))};function Y(){const r=[],e=["red","coral","springGreen","lightSeaGreen","slateBlue","hotpink","violet","orange","darkTurquoise","dodgerblue","blueviolet"];for(let s=1;s<=10;s++){const n=`Username${s}`,o=e[s-1],a=new M(n,{userColor:o});a.addTask(new $("Task 1 for testing propose",`${t()}`)).setCompletionStatus(!0),a.addTask(new $("Task 2 for testing propose",`${t()}`)).setCompletionStatus(!0),a.addTask(new $("Task 3 with a longer description for testing with length",`${t()}`)),r.push(a)}function t(){return`${Math.floor(Math.random()*1e10)}`}return r}class K{constructor(){V(),this.userList=new W,this.tasksCompleted=0,this.totalTasks=0}render(){this.renderTaskList(),this.renderTaskCount(),k(),G()}renderTaskList(){const e=document.createDocumentFragment();this.userList.getAllUsers().forEach(o=>{const a=document.createElement("div");a.classList.add("card"),a.dataset.user=o.username;const i=document.createElement("div");i.classList.add("username"),i.innerText=o.username,i.style.color=window.configs.settings.showUsernameColor?o.userColor:"",a.appendChild(i);const c=document.createElement("ol");c.classList.add("tasks"),o.tasks.forEach((S,d)=>{const l=document.createElement("li");l.classList.add("task"),l.dataset.taskId=`${o.username}-${S.id}`,l.innerText=S.description,S.isComplete()&&l.classList.add("done"),c.appendChild(l)}),a.appendChild(c),e.appendChild(a)});const t=e.cloneNode(!0),s=document.querySelector(".task-container.primary");s.innerHTML="",s.appendChild(e);const n=document.querySelector(".task-container.secondary");n.innerHTML="",n.appendChild(t)}renderTaskCount(){let e=this.userList.tasksCompleted,t=this.userList.totalTasks;const s=document.querySelector(".task-count");s.innerText=`${e}/${t}`}chatHandler(e,t,s,n,o){t=`!${t.toLowerCase()}`;const{admin:a,user:i,settings:{languageCode:c,maxTasksPerUser:S}}=window.configs;let d="",l="";try{if(_(n)){if(a.commands.clearList.includes(t))return this.userList.clearUserList(),d=a.responseTo[c].clearList,U(d,e,l);if(a.commands.clearDone.includes(t))return this.userList.clearDoneTasks(),d=a.responseTo[c].clearDone,U(d,e,l);if(a.commands.clearUser.includes(t))return this.userList.deleteUser(s),l=s,d=a.responseTo[c].clearUser,U(d,e,l)}if(i.commands.addTask.includes(t)){if(s==="")throw new Error("Task description is empty");let f=this.userList.getUser(e)||this.userList.createUser(e,{userColor:o.userColor});const C=s.split(", ");f.getTasks().length+C.length>S?d=i.responseTo[c].maxTasksAdded:(this.userList.addUserTasks(e,C).forEach(L=>{this.addTaskToDOM(e,L)}),l=s,d=i.responseTo[c].addTask)}else if(i.commands.editTask.includes(t)){const f=s.search(new RegExp("(?<=\\d)\\s"));if(f===-1)throw new Error("Task number or description format is invalid");const C=s.slice(0,f),T=s.slice(f+1),L=this.userList.editUserTask(e,D(C),T);this.updateTaskFromDOM(e,L),l=C,d=i.responseTo[c].editTask}else if(i.commands.finishTask.includes(t)){let f=s.split(", ").map(T=>D(T));this.userList.completeUserTasks(e,f).forEach(({id:T})=>{this.completeTaskFromDOM(e,T)}),l=s,d=i.responseTo[c].finishTask}else if(i.commands.deleteTask.includes(t)){const f=s.split(", ").map(T=>D(T)),C=this.userList.deleteUserTasks(e,f);C.forEach(({id:T})=>{this.deleteTaskFromDOM(e,T)}),l=C.map(T=>T.description).join(", "),d=i.responseTo[c].deleteTask}else if(i.commands.check.includes(t))l=this.userList.checkUserTasks(e).join(", "),l===""?d=i.responseTo[c].noTaskFound:d=i.responseTo[c].check;else if(i.commands.help.includes(t))d=i.responseTo[c].help;else if(i.commands.additional.includes(t))d=i.responseTo[c].additional;else throw new Error("command not found");return U(d,e,l)}catch(f){return U(i.responseTo[c].invalidCommand,e,f.message,!0)}}addTaskToDOM(e,t){const s=document.querySelector(`data-user="${e}"`),n=document.createElement("li");n.classList.add("task"),n.dataset.taskId=`${e}-${t.id}`,n.innerText=t.description,s.querySelector(".tasks").appendChild(n),this.totalTasks++,this.renderTaskCount()}updateTaskFromDOM(e,t){const s=document.querySelector(`data-task-id="${e}-${t.id}"`);s.innerText=t.description}completeTaskFromDOM(e,t){document.querySelector(`data-task-id="${e}-${t}"`).classList.add("done"),this.tasksCompleted++,this.renderTaskCount()}deleteTaskFromDOM(e,t){document.querySelector(`data-task-id="${e}-${t}"`).remove(),this.totalTasks--,this.tasksCompleted--,this.renderTaskCount()}}function U(r,e,t,s=!1){return{message:r.replace("{user}",e).replace("{message}",t),error:s}}function _(r){return r.broadcaster||r.mod}function D(r){return parseInt(r,10)-1}function B(r){let e=0,t=null,s=null,n=null,o=null;if(r[e]==="@"){let c=r.indexOf(" ");t=r.slice(1,c),e=c+1}if(r[e]===":"){e+=1;let c=r.indexOf(" ",e);s=r.slice(e,c),e=c+1}let a=r.indexOf(":",e);a===-1&&(a=r.length),n=r.slice(e,a).trim(),a!==r.length&&(e=a+1,o=r.slice(e));let i={command:null,parameters:null,source:null,tags:null};return i.command=z(n),i.command===null?null:(t!==null&&(i.tags=Q(t)),i.source=Z(s),i.parameters=o,o&&o[0]==="!"&&(i.command=X(o,i.command)),i)}function z(r){let e=null;const t=r.split(" ");switch(t[0]){case"JOIN":case"PART":case"NOTICE":case"CLEARCHAT":case"HOSTTARGET":case"PRIVMSG":e={command:t[0],channel:t[1]};break;case"PING":e={command:t[0]};break;case"CAP":e={command:t[0],isCapRequestEnabled:t[2]==="ACK"};break;case"GLOBALUSERSTATE":e={command:t[0]};break;case"USERSTATE":case"ROOMSTATE":e={command:t[0],channel:t[1]};break;case"RECONNECT":console.log("The Twitch IRC server is about to terminate the connection for maintenance."),e={command:t[0]};break;case"421":return console.log(`Unsupported IRC command: ${t[2]}`),null;case"001":e={command:t[0]};break;case"002":case"003":case"004":case"353":case"366":case"375":case"372":case"376":return null;default:return console.log(`Unexpected command: ${t[0]}`),null}return e}function Q(r){const e={"client-nonce":null,flags:null};let t={};return r.split(";").forEach(n=>{let o=n.split("="),a=o[1]===""?null:o[1];switch(o[0]){case"badges":case"badge-info":if(a){let c={};a.split(",").forEach(d=>{let l=d.split("/");c[l[0]]=l[1]}),t[o[0]]=c}else t[o[0]]=null;break;case"emotes":if(a){let c={};a.split("/").forEach(d=>{let l=d.split(":"),f=[];l[1].split(",").forEach(T=>{let L=T.split("-");f.push({startPosition:L[0],endPosition:L[1]})}),c[l[0]]=f}),t[o[0]]=c}else t[o[0]]=null;break;case"emote-sets":let i=a.split(",");t[o[0]]=i;break;default:e.hasOwnProperty(o[0])||(t[o[0]]=a)}}),t}function Z(r){if(r==null)return null;{let e=r.split("!");return{nick:e.length==2?e[0]:null,host:e.length==2?e[1]:e[0]}}}function X(r,e){let s=r.slice(0+1).trim(),n=s.indexOf(" ");return n===-1?(e.botCommand=s.slice(0),e.botCommandParams=""):(e.botCommand=s.slice(0,n),e.botCommandParams=s.slice(n).trim()),e}class ee{constructor(){this.events=new Map}on(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}emit(e,...t){this.events.has(e)&&this.events.get(e).forEach(s=>s(...t))}off(e,t){if(this.events.has(e)){const s=this.events.get(e),n=s.indexOf(t);n!==-1&&(s.splice(n,1),s.length===0&&this.events.delete(e))}}once(e,t){const s=(...n)=>{t(...n),this.off(e,s)};this.on(e,s)}}class te extends ee{constructor({username:t,authToken:s,channel:n}){super();b(this,P);b(this,u,null);this.username=t.toLowerCase(),this.channel=`#${n.toLowerCase()}`,this.authToken=s}connect(t="ws://irc-ws.chat.twitch.tv:80"){O(this,u,new WebSocket(t)),m(this,u).onopen=()=>{m(this,u).send("CAP REQ :twitch.tv/tags twitch.tv/commands"),m(this,u).send(`PASS ${this.authToken}`),m(this,u).send(`NICK ${this.username}`),console.log("Authenticating with Twitch IRC server...")},m(this,u).onerror=s=>{console.error("Error connecting to Twitch IRC",s)},m(this,u).onmessage=s=>{g(this,P,q).call(this,s.data)},m(this,u).onclose=()=>{console.log("Disconnected from Twitch IRC")}}say(t,s){if(m(this,u).readyState===WebSocket.OPEN){let n="";s&&(n=s?`@reply-parent-msg-id=${s}`:"");const o=[n,"PRIVMSG",this.channel,`:${t}`].join(" ").trim();m(this,u).send(o)}else console.error("Connection is not open")}close(){m(this,u)&&m(this,u).close()}}u=new WeakMap,P=new WeakSet,q=function(t){t.trim().split(`\r
`).forEach(n=>{const o=B(n);if(o)switch(o.command.command){case"PRIVMSG":if(o.parameters.startsWith("!")){const a=se(o);this.emit("command",a)}break;case"PING":m(this,u).send("PONG "+o.parameters);break;case"001":m(this,u).send(`JOIN ${this.channel}`);break;case"JOIN":console.log(`Joined ${this.channel}`);break;case"PART":console.log("The channel must have banned (/ban) the bot."),m(this,u).close();break;case"NOTICE":o.parameters==="Login authentication failed"?(console.log(`Authentication failed; left ${this.channel}`),m(this,u).send(`PART ${this.channel}`)):o.parameters==="You don't have permission to perform that action"&&(console.log(`No permission. Check if the access token is still valid. Left ${this.channel}`),m(this,u).send(`PART ${this.channel}`));break}})};function se(r){var e,t;return{user:r.tags["display-name"],command:r.command.botCommand,message:r.command.botCommandParams||"",flags:{broadcaster:!!((e=r.tags.badges)!=null&&e.broadcaster),mod:!!((t=r.tags.badges)!=null&&t.moderator)},extra:{userColor:r.tags.color,messageId:r.tags.id}}}const{twitch_channel:ne,twitch_oauth:re,twitch_username:oe}=configs.auth;window.addEventListener("load",()=>{const r=new K;r.render();const e=new te({username:oe,authToken:re,channel:ne});e.on("command",t=>{const{user:s,command:n,message:o,flags:a,extra:i}=t,c=r.chatHandler(s,n,o,a,i);c.error||e.say(c,i.messageId)}),e.connect()})})();
