var q=(h,f,k)=>{if(!f.has(h))throw TypeError("Cannot "+k)};var d=(h,f,k)=>(q(h,f,"read from private field"),k?k.call(h):f.get(h)),E=(h,f,k)=>{if(f.has(h))throw TypeError("Cannot add the same private member more than once");f instanceof WeakSet?f.add(h):f.set(h,k)},v=(h,f,k,U)=>(q(h,f,"write to private field"),U?U.call(h,k):f.set(h,k),k);var C=(h,f,k)=>(q(h,f,"access private method"),k);(function(){"use strict";var O,W,$,M,j,S,L,m,P,y,A,Y,N,K;let h,f,k=!1;function U(){const e=document.querySelector(".task-wrapper").clientHeight,t=document.querySelector(".task-container.primary"),s=t.scrollHeight,n=document.querySelector(".task-container.secondary");if(s>e&&!k){n.style.display="flex";const r=configs.settings.scrollSpeed;let a=parseInt(r,10),c={duration:s/a*1e3,iterations:1,easing:"linear"};const w=getComputedStyle(document.documentElement).getPropertyValue("--card-gap-between").slice(0,-2);let l=s+parseInt(w,10),p=[{transform:"translateY(0)"},{transform:`translateY(-${l}px)`}],u=[{transform:"translateY(0)"},{transform:`translateY(-${l}px)`}];h=t.animate(p,c),f=n.animate(u,c),k=!0,B()}else s<=e&&(n.style.display="none",_())}function _(){h&&h.cancel(),f&&f.cancel(),k=!1}function B(){h&&(h.addEventListener("finish",R),h.addEventListener("cancel",R))}function R(){k=!1,U()}function z(){const o=["!add","!edit","!done","!delete","!taskhelp"],e=document.querySelector(".command-code");let t=0;setInterval(()=>{e.style.opacity=0,setTimeout(()=>{e.innerText=o[t],e.style.opacity=1,t=(t+1)%o.length},1e3)},7e3)}function Q(){const o=document.querySelector(":root");for(let[e,t]of Object.entries(configs.styles))e.includes("FontFamily")&&Z(t),o.style.setProperty(X(e),t)}function Z(o){WebFont.load({google:{families:[`${o}:100,400,700`]}})}function X(o){return`--${o.replace(/([A-Z])/g,"-$1").toLowerCase()}`}class H{constructor(e,t){this.username=this.validateUsername(e),this.userColor=(t==null?void 0:t.userColor)||"",this.tasks=[]}validateUsername(e){if(typeof e!="string")throw new Error("Username must be of type string");if(e=e.trim(),e.length===0)throw new Error("Username invalid");return e}addTask(e){return this.tasks.push(e),e}editTask(e,t){let s=this.getTask(e);return s.setDescription(t),s}completeTask(e){let t=this.getTask(e);return t.setCompletionStatus(!0),t}deleteTask(e){const t=[].concat(e);t.forEach(n=>this.validateTaskIndex(n));const s=[];return this.tasks=this.tasks.filter((n,r)=>{if(t.includes(r))s.push(n);else return!0}),s}removeCompletedTasks(){const e=[];return this.tasks=this.tasks.filter(t=>t.isComplete()?(e.push(t),!1):!0),e}getTask(e){return this.validateTaskIndex(e),this.tasks[e]}getTasks(){return this.tasks}validateTaskIndex(e){if(typeof e!="number"||isNaN(e))throw new Error("Task index must be a number");if(e<0||e>=this.tasks.length)throw new Error("Task index out of bounds");return!0}}class G{constructor(e){E(this,O);this.description=this.validateDescription(e),this.id=C(this,O,W).call(this),this.completionStatus=!1}validateDescription(e){if(typeof e!="string")throw new Error("Task description must be of type string");if(e=e.trim(),e.length===0)throw new Error("Task description invalid");return e}setDescription(e){this.description=this.validateDescription(e)}isComplete(){return this.completionStatus}setCompletionStatus(e){if(typeof e!="boolean")throw new Error("Completion status must be of type boolean");this.completionStatus=e}}O=new WeakSet,W=function(){const e=new Date,t=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),r=String(e.getSeconds()).padStart(2,"0"),a=String(e.getMilliseconds()).padStart(3,"0"),i=Math.floor(Math.random()*1e4);return`${t}${s}${n}${r}${a}${i}`};class ee{constructor(e="userList"){E(this,M);E(this,S);E(this,$,void 0);v(this,$,e),this.tasksCompleted=0,this.totalTasks=0,this.users=C(this,M,j).call(this)}getUser(e){return this.users.find(s=>s.username===e)}getAllUsers(){return this.users}createUser(e,t){if(this.getUser(e))throw new Error(`${e} already exists`);const s=new H(e,t);return this.users.push(s),s}addUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`${e} does not exist`);const n=[].concat(t),r=[];return n.forEach(a=>{r.push(s.addTask(new G(a))),this.totalTasks++}),C(this,S,L).call(this),r}editUserTask(e,t,s){const n=this.getUser(e);if(!n)throw new Error(`${e} has no tasks`);const r=n.editTask(t,s);return C(this,S,L).call(this),r}completeUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`${e} has no tasks`);const r=[].concat(t).map(a=>{const i=s.getTask(a);return i.isComplete()||(i.setCompletionStatus(!0),this.tasksCompleted++),i});return C(this,S,L).call(this),r}deleteUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`${e} has no tasks`);const n=[].concat(t),r=s.deleteTask(n);return this.decreaseTaskCount(r),C(this,S,L).call(this),r}checkUserTasks(e,t="incomplete"){const s=this.getUser(e);if(!s)throw new Error(`${e} has no tasks`);const n=new Map;return s.getTasks().forEach((r,a)=>{t==="incomplete"&&!r.isComplete()&&n.set(a,r),t==="complete"&&r.isComplete()&&n.set(a,r)}),n}clearUserList(){this.users=[],this.tasksCompleted=0,this.totalTasks=0,C(this,S,L).call(this)}clearDoneTasks(){let e=[];return this.users.forEach(t=>{let s=t.removeCompletedTasks();this.decreaseTaskCount(s),e=e.concat(s)}),C(this,S,L).call(this),e}deleteUser(e){const t=this.users.findIndex(r=>r.username===e);if(t===-1)throw new Error(`${e} not found`);const s=this.users[t],n=this.users.splice(t,1)[0];return this.decreaseTaskCount(n.getTasks()),C(this,S,L).call(this),s}decreaseTaskCount(e){e.forEach(t=>{t.isComplete()&&this.tasksCompleted--,this.totalTasks--})}}$=new WeakMap,M=new WeakSet,j=function(){let e=localStorage.getItem(d(this,$));return e?(e=JSON.parse(e),e.map(t=>{const s=new H(t.username,{userColor:t.userColor});return t.tasks.map(n=>{const r=s.addTask(new G(n.description,n.id));this.totalTasks++,n.completionStatus&&(r.setCompletionStatus(n.completionStatus),this.tasksCompleted++)}),s})):(e=[],localStorage.setItem(d(this,$),JSON.stringify(e)),e)},S=new WeakSet,L=function(){localStorage.setItem(d(this,$),JSON.stringify(this.users))};class te{constructor(e="userList"){this.userList=new ee(e),Q()}render(){z(),this.renderTaskList(),this.renderTaskCount()}renderTaskList(){if(this.userList.users.length===0)return;const e=document.createDocumentFragment();this.userList.getAllUsers().forEach(a=>{const i=V(a),c=i.querySelector("ol");a.tasks.forEach(w=>{const l=document.createElement("li");l.classList.add("task"),l.dataset.taskId=`${w.id}`,l.innerText=w.description,w.isComplete()&&l.classList.add("done"),c.appendChild(l)}),e.appendChild(i)});const t=e.cloneNode(!0),s=document.querySelector(".task-container.primary");s.innerHTML="",s.appendChild(t);const n=e.cloneNode(!0),r=document.querySelector(".task-container.secondary");r.innerHTML="",r.appendChild(n),U()}renderTaskCount(){let e=this.userList.tasksCompleted,t=this.userList.totalTasks;const s=document.querySelector(".task-count");s.innerText=`${e}/${t}`}chatHandler(e,t,s,n,r){t=`!${t.toLowerCase()}`;const{admin:a,user:i,settings:{languageCode:c,maxTasksPerUser:w}}=window.configs;let l="",p="";try{if(se(n)){if(a.commands.clearList.includes(t))return this.userList.clearUserList(),this.clearListFromDOM(),l=a.responseTo[c].clearList,I(l,e,p);if(a.commands.clearDone.includes(t))return this.userList.clearDoneTasks().forEach(({id:g})=>{this.deleteTaskFromDOM(g)}),l=a.responseTo[c].clearDone,I(l,e,p);if(a.commands.clearUser.includes(t)){const u=this.userList.deleteUser(s);return this.deleteUserFromDOM(u),p=u.username,l=a.responseTo[c].clearUser,I(l,e,p)}}if(i.commands.addTask.includes(t)){if(s==="")throw new Error("Task description is empty");let u=this.userList.getUser(e)||this.userList.createUser(e,{userColor:r.userColor});const g=s.split(", ");u.getTasks().length+g.length>w?l=i.responseTo[c].maxTasksAdded:(this.userList.addUserTasks(e,g).forEach(b=>{this.addTaskToDOM(u,b)}),p=s,l=i.responseTo[c].addTask)}else if(i.commands.editTask.includes(t)){const u=s.search(new RegExp("(?<=\\d)\\s"));if(u===-1)throw new Error("Task number or description format is invalid");const g=s.slice(0,u),T=s.slice(u+1),b=this.userList.editUserTask(e,D(g),T);this.editTaskFromDOM(b),p=g,l=i.responseTo[c].editTask}else if(i.commands.finishTask.includes(t)){let u=s.split(", ").map(T=>D(T));this.userList.completeUserTasks(e,u).forEach(({id:T})=>{this.completeTaskFromDOM(T)}),p=s,l=i.responseTo[c].finishTask}else if(i.commands.deleteTask.includes(t)){const u=s.split(", ").map(T=>D(T));this.userList.deleteUserTasks(e,u).forEach(({id:T})=>{this.deleteTaskFromDOM(T)}),p=s,l=i.responseTo[c].deleteTask}else if(i.commands.check.includes(t)){const u=this.userList.checkUserTasks(e),g=[];for(let[T,b]of u)g.push(`${T+1}. ${b.description}`);p=g.join(" | "),p===""?l=i.responseTo[c].noTaskFound:l=i.responseTo[c].check}else if(i.commands.help.includes(t))l=i.responseTo[c].help;else if(i.commands.additional.includes(t))l=i.responseTo[c].additional;else throw new Error("command not found");return I(l,e,p)}catch(u){return I(i.responseTo[c].invalidCommand,e,u.message,!0)}}clearListFromDOM(){const e=document.querySelector(".task-container.primary"),t=document.querySelector(".task-container.secondary");e.innerHTML="",t.innerHTML="",this.renderTaskCount()}addTaskToDOM(e,t){const s=document.querySelector(".task-container.primary"),n=document.querySelector(".task-container.secondary");if(document.querySelectorAll(`[data-user="${e.username}"]`).length===0){const c=V(e),w=c.cloneNode(!0);s.appendChild(c),n.appendChild(w)}const a=document.createElement("li");a.classList.add("task"),a.dataset.taskId=`${t.id}`,a.innerText=t.description;const i=a.cloneNode(!0);s.querySelector(`[data-user="${e.username}"] .tasks`).appendChild(a),n.querySelector(`[data-user="${e.username}"] .tasks`).appendChild(i),this.renderTaskCount(),U()}editTaskFromDOM(e){const t=document.querySelectorAll(`[data-task-id="${e.id}"]`);for(const s of t)s.innerText=e.description}completeTaskFromDOM(e){const t=document.querySelectorAll(`[data-task-id="${e}"]`);for(const s of t)s.classList.add("done");this.renderTaskCount()}deleteTaskFromDOM(e){const t=document.querySelectorAll(`[data-task-id="${e}"]`);for(const s of t)s.parentElement.children.length===1?s.parentElement.parentElement.remove():s.remove();this.renderTaskCount()}deleteUserFromDOM(e){const{username:t,tasks:s}=e,n=document.querySelectorAll(`[data-user="${t}"]`);for(let r of n)r.remove();s.forEach(r=>{r.isComplete()}),this.renderTaskCount()}}function I(o,e,t,s=!1){return{message:o.replace("{user}",e).replace("{message}",t),error:s}}function se(o){return o.broadcaster||o.mod}function D(o){return parseInt(o,10)-1}function V({username:o,userColor:e}){const t=document.createElement("div");t.classList.add("card"),t.dataset.user=o;const s=document.createElement("div");s.classList.add("username"),s.innerText=o,s.style.color=window.configs.settings.showUsernameColor?e:"",t.appendChild(s);const n=document.createElement("ol");return n.classList.add("tasks"),t.appendChild(n),t}function ne(o){const e={command:null,parameters:null,source:null,tags:null};let t=0,s=null,n=null,r=null,a=null;if(o[t]==="@"){let c=o.indexOf(" ");s=o.slice(1,c),t=c+1}if(o[t]===":"){t+=1;let c=o.indexOf(" ",t);n=o.slice(t,c),t=c+1}let i=o.indexOf(":",t);return i===-1&&(i=o.length),r=o.slice(t,i).trim(),i!==o.length&&(t=i+1,a=o.slice(t)),e.command=re(r),e.command===null?null:(s!==null&&(e.tags=oe(s)),e.source=ae(n),e.parameters=a,a&&a[0]==="!"&&(e.command=ie(a,e.command)),e)}function re(o){let e=null;const t=o.split(" ");switch(t[0]){case"JOIN":case"PART":case"NOTICE":case"CLEARCHAT":case"HOSTTARGET":case"PRIVMSG":e={command:t[0],channel:t[1]};break;case"PING":e={command:t[0]};break;case"CAP":e={command:t[0],isCapRequestEnabled:t[2]==="ACK"};break;case"GLOBALUSERSTATE":e={command:t[0]};break;case"USERSTATE":case"ROOMSTATE":e={command:t[0],channel:t[1]};break;case"RECONNECT":e={command:t[0]};break;case"421":return console.error(`Unsupported IRC command: ${t[2]}`),null;case"001":e={command:t[0]};break;case"002":case"003":case"004":case"353":case"366":case"372":case"375":case"376":return null;default:return console.log(`Unexpected command: ${t[0]}`),null}return e}function oe(o){const e={"client-nonce":null,flags:null};let t={};return o.split(";").forEach(n=>{let r=n.split("="),a=r[1]===""?null:r[1];switch(r[0]){case"badges":case"badge-info":if(a){let c={};a.split(",").forEach(l=>{let p=l.split("/");c[p[0]]=p[1]}),t[r[0]]=c}else t[r[0]]=null;break;case"emotes":if(a){let c={};a.split("/").forEach(l=>{let p=l.split(":"),u=[];p[1].split(",").forEach(T=>{let b=T.split("-");u.push({startPosition:b[0],endPosition:b[1]})}),c[p[0]]=u}),t[r[0]]=c}else t[r[0]]=null;break;case"emote-sets":let i=a.split(",");t[r[0]]=i;break;default:e.hasOwnProperty(r[0])||(t[r[0]]=a)}}),t}function ae(o){if(o==null)return null;{let e=o.split("!");return{nick:e.length==2?e[0]:null,host:e.length==2?e[1]:e[0]}}}function ie(o,e){let s=o.slice(0+1).trim(),n=s.indexOf(" ");return n===-1?(e.botCommand=s.slice(0),e.botCommandParams=""):(e.botCommand=s.slice(0,n),e.botCommandParams=s.slice(n).trim()),e}class ce{constructor(){this.events=new Map}on(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}emit(e,...t){this.events.has(e)&&this.events.get(e).forEach(s=>s(...t))}off(e,t){if(this.events.has(e)){const s=this.events.get(e),n=s.indexOf(t);n!==-1&&(s.splice(n,1),s.length===0&&this.events.delete(e))}}once(e,t){const s=(...n)=>{t(...n),this.off(e,s)};this.on(e,s)}}class le extends ce{constructor({username:t,authToken:s,channel:n}){super();E(this,A);E(this,N);E(this,m,null);E(this,P,{0:"CONNECTING",1:"OPEN",2:"CLOSING",3:"CLOSED"});E(this,y,0);this.username=t.toLowerCase(),this.channel=`#${n.toLowerCase()}`,this.authToken=s}connect(t="ws://irc-ws.chat.twitch.tv:80"){v(this,m,new WebSocket(t)),d(this,m).onopen=()=>{console.log("Authenticating with Twitch IRC server..."),d(this,m).send("CAP REQ :twitch.tv/tags twitch.tv/commands"),d(this,m).send(`PASS ${this.authToken}`),d(this,m).send(`NICK ${this.username}`)},d(this,m).onerror=s=>(console.error("An error occurred while attempting to establish a WebSocket connect",s),s),d(this,m).onmessage=s=>{C(this,A,Y).call(this,s.data)},d(this,m).onclose=s=>{switch(s.code){case 1e3:console.log("Connection closed normally.");break;case 1006:console.error(`Connection dropped. Reconnecting in ${d(this,y)} milliseconds...`);let n=d(this,y);setTimeout(()=>{this.connect()},n),v(this,y,d(this,y)===0?1e3:d(this,y)*2);break;case 1012:console.log("Switching  servers..."),this.connect();break;default:console.error(`Unhandled code: ${s.code}. Reason: ${s.reason}`)}}}say(t,s){if(d(this,m).readyState===WebSocket.OPEN){const r=[s?`@reply-parent-msg-id=${s}`:"","PRIVMSG",this.channel,`:${t}`].join(" ").trim();d(this,m).send(r)}else console.error("Connection is not open")}disconnect(t=1e3,s=""){C(this,N,K).call(this)==="OPEN"&&d(this,m).close({code:t,reason:s})}}m=new WeakMap,P=new WeakMap,y=new WeakMap,A=new WeakSet,Y=function(t){t.trim().split(`\r
`).forEach(n=>{const r=ne(n);if(r)switch(r.command.command){case"PRIVMSG":if(r.parameters.startsWith("!")){const a=de(r);this.emit("command",a)}break;case"PING":d(this,m).send("PONG "+r.parameters);break;case"001":d(this,m).send(`JOIN ${this.channel}`);break;case"JOIN":console.log(`Joined ${this.channel}`),v(this,y,0);break;case"RECONNECT":this.disconnect(1012,"The Twitch IRC server is terminating the connection for maintenance reasons.");break;case"PART":console.error("The channel must have banned (/ban) the bot."),d(this,m).close();break;case"NOTICE":r.parameters==="Login authentication failed"?(console.error(`Authentication failed; left #${this.channel}`),d(this,m).send(`PART ${this.channel}`)):r.parameters==="You don't have permission to perform that action"&&(console.error(`No permission. Check if the access token is still valid. Left ${this.channel}`),d(this,m).send(`PART ${this.channel}`));break}})},N=new WeakSet,K=function(){return d(this,P)[d(this,m).readyState]};function de(o){var e,t;return{user:o.tags["display-name"],command:o.command.botCommand,message:o.command.botCommandParams||"",flags:{broadcaster:!!((e=o.tags.badges)!=null&&e.broadcaster),mod:!!((t=o.tags.badges)!=null&&t.moderator)},extra:{userColor:o.tags.color,messageId:o.tags.id}}}function ue(o){o.emit("command",{user:"adminUser",command:"clearList",message:"",flags:{broadcaster:!0,mod:!1},extra:{userColor:"#FF0000",messageId:`${F()}`}});const e=["red","coral","springGreen","lightSeaGreen","slateBlue","hotpink","violet","orange","darkTurquoise","dodgerblue","blueviolet"];for(let t=1;t<=8;t++){const s=`Username${t}`,n=e[t-1];for(let r=0;r<3;r++){const a={user:s,command:"taskadd",message:`test task description ${r===2?"with longer text for example":""}`,flags:{broadcaster:!0,mod:!1},extra:{userColor:n,messageId:`${F()}`}};setTimeout(()=>{o.emit("command",a)},1e3*t+r*100)}setTimeout(()=>{const r={user:s,command:"taskdone",message:"1",flags:{broadcaster:!0,mod:!1},extra:{userColor:n,messageId:`${F()}`}};o.emit("command",r)},1e3*t+1e4)}}function F(){return`${Math.floor(Math.random()*1e9)}`}const{auth:{twitch_channel:he,twitch_oauth:me,twitch_username:pe},settings:{testMode:J}}=configs,x=new le({username:pe,authToken:me,channel:he});window.addEventListener("load",()=>{let o="userList";J&&(console.log("Test mode enabled"),o="testUserList");const e=new te(o);e.render(),x.on("command",t=>{const{user:s,command:n,message:r,flags:a,extra:i}=t,c=e.chatHandler(s,n,r,a,i);c.error?console.error(c.message):x.say(c.message,i.messageId)}),x.connect(),J&&ue(x)})})();
