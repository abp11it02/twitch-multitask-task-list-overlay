var H=(d,h,f)=>{if(!h.has(d))throw TypeError("Cannot "+f)};var u=(d,h,f)=>(H(d,h,"read from private field"),f?f.call(d):h.get(d)),E=(d,h,f)=>{if(h.has(d))throw TypeError("Cannot add the same private member more than once");h instanceof WeakSet?h.add(d):h.set(d,f)},v=(d,h,f,S)=>(H(d,h,"write to private field"),S?S.call(d,f):h.set(d,f),f);var I=(d,h,f,S)=>({set _(F){v(d,h,F,f)},get _(){return u(d,h,S)}}),w=(d,h,f)=>(H(d,h,"access private method"),f);(function(){"use strict";var P,W,U,A,Y,y,$,b,L,p,D,K;let d,h,f=!1;function S(){const e=document.querySelector(".task-wrapper").clientHeight,t=document.querySelector(".task-container.primary"),s=t.scrollHeight,o=document.querySelector(".task-container.secondary");if(s>e&&!f){o.style.display="flex";const r=configs.settings.scrollSpeed;let a=parseInt(r,10),c={duration:s/a*1e3,iterations:1,easing:"linear"};const C=getComputedStyle(document.documentElement).getPropertyValue("--card-gap-between").slice(0,-2);let l=s+parseInt(C,10),k=[{transform:"translateY(0)"},{transform:`translateY(-${l}px)`}],m=[{transform:"translateY(0)"},{transform:`translateY(-${l}px)`}];d=t.animate(k,c),h=o.animate(m,c),f=!0,_()}else s<=e&&(o.style.display="none",F())}function F(){d&&d.cancel(),h&&h.cancel(),f=!1}function _(){d&&(d.addEventListener("finish",G),d.addEventListener("cancel",G))}function G(){f=!1,S()}function B(){const n=["!add","!edit","!done","!delete","!taskhelp"],e=document.querySelector(".command-code");let t=0;setInterval(()=>{e.style.opacity=0,setTimeout(()=>{e.innerText=n[t],e.style.opacity=1,t=(t+1)%n.length},1e3)},7e3)}function z(){const n=document.querySelector(":root");for(let[e,t]of Object.entries(configs.styles))e.includes("FontFamily")&&Q(t),n.style.setProperty(Z(e),t)}function Q(n){WebFont.load({google:{families:[`${n}:100,400,700`]}})}function Z(n){return`--${n.replace(/([A-Z])/g,"-$1").toLowerCase()}`}class V{constructor(e,t){this.username=this.validateUsername(e),this.userColor=(t==null?void 0:t.userColor)||"",this.tasks=[]}validateUsername(e){if(typeof e!="string")throw new Error("Username must be of type string");if(e=e.trim(),e.length===0)throw new Error("Username invalid");return e}addTask(e){return this.tasks.push(e),e}editTask(e,t){let s=this.getTask(e);return s.setDescription(t),s}completeTask(e){let t=this.getTask(e);return t.setCompletionStatus(!0),t}deleteTask(e){const t=[].concat(e);t.forEach(o=>this.validateTaskIndex(o));const s=[];return this.tasks=this.tasks.filter((o,r)=>{if(t.includes(r))s.push(o);else return!0}),s}removeCompletedTasks(){const e=[];return this.tasks=this.tasks.filter(t=>t.isComplete()?(e.push(t),!1):!0),e}getTask(e){return this.validateTaskIndex(e),this.tasks[e]}getTasks(){return this.tasks}validateTaskIndex(e){if(typeof e!="number"||isNaN(e))throw new Error("Task index must be a number");if(e<0||e>=this.tasks.length)throw new Error("Task index out of bounds");return!0}}class J{constructor(e){E(this,P);this.description=this.validateDescription(e),this.id=w(this,P,W).call(this),this.completionStatus=!1}validateDescription(e){if(typeof e!="string")throw new Error("Task description must be of type string");if(e=e.trim(),e.length===0)throw new Error("Task description invalid");return e}setDescription(e){this.description=this.validateDescription(e)}isComplete(){return this.completionStatus}setCompletionStatus(e){if(typeof e!="boolean")throw new Error("Completion status must be of type boolean");this.completionStatus=e}}P=new WeakSet,W=function(){const e=new Date,t=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),r=String(e.getSeconds()).padStart(2,"0"),a=String(e.getMilliseconds()).padStart(3,"0"),i=Math.floor(Math.random()*1e4);return`${t}${s}${o}${r}${a}${i}`};class X{constructor(e="userList"){E(this,A);E(this,y);E(this,U,void 0);v(this,U,e),this.users=w(this,A,Y).call(this)}getUser(e){return this.users.find(s=>s.username===e)}getAllUsers(){return this.users}createUser(e,t){if(this.getUser(e))throw new Error(`${e} already exists`);const s=new V(e,t);return this.users.push(s),s}addUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`${e} does not exist`);const o=[].concat(t),r=[];return o.forEach(a=>{r.push(s.addTask(new J(a)))}),w(this,y,$).call(this),r}editUserTask(e,t,s){const o=this.getUser(e);if(!o)throw new Error(`${e} has no tasks`);const r=o.editTask(t,s);return w(this,y,$).call(this),r}completeUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`${e} has no tasks`);const r=[].concat(t).map(a=>s.completeTask(a));return w(this,y,$).call(this),r}deleteUserTasks(e,t){const s=this.getUser(e);if(!s)throw new Error(`${e} has no tasks`);const o=[].concat(t),r=s.deleteTask(o);return w(this,y,$).call(this),r}checkUserTasks(e){const t=this.getUser(e);if(!t)throw new Error(`${e} has no tasks`);return t.getTasks().filter(s=>!s.isComplete()).map(s=>s.description)}clearUserList(){this.users=[],w(this,y,$).call(this)}clearDoneTasks(){let e=[];return this.users.forEach(t=>{let s=t.removeCompletedTasks();e=e.concat(s)}),w(this,y,$).call(this),e}deleteUser(e){const t=this.users.findIndex(o=>o.username===e);if(t===-1)throw new Error(`${e} not found`);const s=this.users[t];return this.users.splice(t,1),w(this,y,$).call(this),s}}U=new WeakMap,A=new WeakSet,Y=function(){let e=localStorage.getItem(u(this,U));return e?(e=JSON.parse(e),e.map(t=>{const s=new V(t.username,{userColor:t.userColor});return t.tasks.map(o=>{const r=s.addTask(new J(o.description,o.id));o.completionStatus&&r.setCompletionStatus(o.completionStatus)}),s})):(e=[],localStorage.setItem(u(this,U),JSON.stringify(e)),e)},y=new WeakSet,$=function(){localStorage.setItem(u(this,U),JSON.stringify(this.users))};class ee{constructor(e="userList"){E(this,b,0);E(this,L,0);this.userList=new X(e),z()}render(){B(),this.renderTaskList(),this.renderTaskCount()}renderTaskList(){if(this.userList.users.length===0)return;const e=document.createDocumentFragment();this.userList.getAllUsers().forEach(a=>{const i=j(a),c=i.querySelector("ol");a.tasks.forEach(C=>{const l=document.createElement("li");l.classList.add("task"),l.dataset.taskId=`${C.id}`,l.innerText=C.description,C.isComplete()&&l.classList.add("done"),c.appendChild(l)}),e.appendChild(i)});const t=e.cloneNode(!0),s=document.querySelector(".task-container.primary");s.innerHTML="",s.appendChild(t);const o=e.cloneNode(!0),r=document.querySelector(".task-container.secondary");r.innerHTML="",r.appendChild(o),S()}renderTaskCount(){let e=u(this,b),t=u(this,L);const s=document.querySelector(".task-count");s.innerText=`${e}/${t}`}chatHandler(e,t,s,o,r){t=`!${t.toLowerCase()}`;const{admin:a,user:i,settings:{languageCode:c,maxTasksPerUser:C}}=window.configs;let l="",k="";try{if(te(o)){if(a.commands.clearList.includes(t))return this.userList.clearUserList(),this.clearListFromDOM(),l=a.responseTo[c].clearList,O(l,e,k);if(a.commands.clearDone.includes(t))return this.userList.clearDoneTasks().forEach(({id:g})=>{this.deleteTaskFromDOM(g)}),l=a.responseTo[c].clearDone,O(l,e,k);if(a.commands.clearUser.includes(t)){const m=this.userList.deleteUser(s);return this.deleteUserFromDOM(m),k=m.username,l=a.responseTo[c].clearUser,O(l,e,k)}}if(i.commands.addTask.includes(t)){if(s==="")throw new Error("Task description is empty");let m=this.userList.getUser(e)||this.userList.createUser(e,{userColor:r.userColor});const g=s.split(", ");m.getTasks().length+g.length>C?l=i.responseTo[c].maxTasksAdded:(this.userList.addUserTasks(e,g).forEach(x=>{this.addTaskToDOM(m,x)}),k=s,l=i.responseTo[c].addTask)}else if(i.commands.editTask.includes(t)){const m=s.search(new RegExp("(?<=\\d)\\s"));if(m===-1)throw new Error("Task number or description format is invalid");const g=s.slice(0,m),T=s.slice(m+1),x=this.userList.editUserTask(e,N(g),T);this.editTaskFromDOM(x),k=g,l=i.responseTo[c].editTask}else if(i.commands.finishTask.includes(t)){let m=s.split(", ").map(T=>N(T));this.userList.completeUserTasks(e,m).forEach(({id:T})=>{this.completeTaskFromDOM(T)}),k=s,l=i.responseTo[c].finishTask}else if(i.commands.deleteTask.includes(t)){const m=s.split(", ").map(T=>N(T)),g=this.userList.deleteUserTasks(e,m);g.forEach(({id:T})=>{this.deleteTaskFromDOM(T)}),k=g.map(T=>T.description).join(", "),l=i.responseTo[c].deleteTask}else if(i.commands.check.includes(t))k=this.userList.checkUserTasks(e).join(", "),k===""?l=i.responseTo[c].noTaskFound:l=i.responseTo[c].check;else if(i.commands.help.includes(t))l=i.responseTo[c].help;else if(i.commands.additional.includes(t))l=i.responseTo[c].additional;else throw new Error("command not found");return O(l,e,k)}catch(m){return console.log(m),O(i.responseTo[c].invalidCommand,e,m.message,!0)}}clearListFromDOM(){const e=document.querySelector(".task-container.primary"),t=document.querySelector(".task-container.secondary");e.innerHTML="",t.innerHTML="",v(this,b,0),v(this,L,0),this.renderTaskCount()}addTaskToDOM(e,t){const s=document.querySelector(".task-container.primary"),o=document.querySelector(".task-container.secondary");if(document.querySelectorAll(`[data-user="${e.username}"]`).length===0){const c=j(e),C=c.cloneNode(!0);s.appendChild(c),o.appendChild(C)}const a=document.createElement("li");a.classList.add("task"),a.dataset.taskId=`${t.id}`,a.innerText=t.description;const i=a.cloneNode(!0);s.querySelector(`[data-user="${e.username}"] .tasks`).appendChild(a),o.querySelector(`[data-user="${e.username}"] .tasks`).appendChild(i),I(this,L)._++,this.renderTaskCount(),S()}editTaskFromDOM(e){const t=document.querySelectorAll(`[data-task-id="${e.id}"]`);for(const s of t)s.innerText=e.description}completeTaskFromDOM(e){const t=document.querySelectorAll(`[data-task-id="${e}"]`);for(const s of t)s.classList.add("done");I(this,b)._++,this.renderTaskCount()}deleteTaskFromDOM(e){const t=document.querySelectorAll(`[data-task-id="${e}"]`);for(const s of t)s.parentElement.children.length===1?s.parentElement.parentElement.remove():s.remove();I(this,L)._--,I(this,b)._--,this.renderTaskCount()}deleteUserFromDOM(e){const{username:t,tasks:s}=e,o=document.querySelectorAll(`[data-user="${t}"]`);for(let r of o)r.remove();s.forEach(r=>{r.isComplete()&&I(this,b)._--,I(this,L)._--}),this.renderTaskCount()}}b=new WeakMap,L=new WeakMap;function O(n,e,t,s=!1){return{message:n.replace("{user}",e).replace("{message}",t),error:s}}function te(n){return n.broadcaster||n.mod}function N(n){return parseInt(n,10)-1}function j({username:n,userColor:e}){const t=document.createElement("div");t.classList.add("card"),t.dataset.user=n;const s=document.createElement("div");s.classList.add("username"),s.innerText=n,s.style.color=window.configs.settings.showUsernameColor?e:"",t.appendChild(s);const o=document.createElement("ol");return o.classList.add("tasks"),t.appendChild(o),t}function se(n){let e=0,t=null,s=null,o=null,r=null;if(n[e]==="@"){let c=n.indexOf(" ");t=n.slice(1,c),e=c+1}if(n[e]===":"){e+=1;let c=n.indexOf(" ",e);s=n.slice(e,c),e=c+1}let a=n.indexOf(":",e);a===-1&&(a=n.length),o=n.slice(e,a).trim(),a!==n.length&&(e=a+1,r=n.slice(e));let i={command:null,parameters:null,source:null,tags:null};return i.command=ne(o),i.command===null?null:(t!==null&&(i.tags=re(t)),i.source=oe(s),i.parameters=r,r&&r[0]==="!"&&(i.command=ae(r,i.command)),i)}function ne(n){let e=null;const t=n.split(" ");switch(t[0]){case"JOIN":case"PART":case"NOTICE":case"CLEARCHAT":case"HOSTTARGET":case"PRIVMSG":e={command:t[0],channel:t[1]};break;case"PING":e={command:t[0]};break;case"CAP":e={command:t[0],isCapRequestEnabled:t[2]==="ACK"};break;case"GLOBALUSERSTATE":e={command:t[0]};break;case"USERSTATE":case"ROOMSTATE":e={command:t[0],channel:t[1]};break;case"RECONNECT":console.log("The Twitch IRC server is about to terminate the connection for maintenance."),e={command:t[0]};break;case"421":return console.log(`Unsupported IRC command: ${t[2]}`),null;case"001":e={command:t[0]};break;case"002":case"003":case"004":case"353":case"366":case"375":case"372":case"376":return null;default:return console.log(`Unexpected command: ${t[0]}`),null}return e}function re(n){const e={"client-nonce":null,flags:null};let t={};return n.split(";").forEach(o=>{let r=o.split("="),a=r[1]===""?null:r[1];switch(r[0]){case"badges":case"badge-info":if(a){let c={};a.split(",").forEach(l=>{let k=l.split("/");c[k[0]]=k[1]}),t[r[0]]=c}else t[r[0]]=null;break;case"emotes":if(a){let c={};a.split("/").forEach(l=>{let k=l.split(":"),m=[];k[1].split(",").forEach(T=>{let x=T.split("-");m.push({startPosition:x[0],endPosition:x[1]})}),c[k[0]]=m}),t[r[0]]=c}else t[r[0]]=null;break;case"emote-sets":let i=a.split(",");t[r[0]]=i;break;default:e.hasOwnProperty(r[0])||(t[r[0]]=a)}}),t}function oe(n){if(n==null)return null;{let e=n.split("!");return{nick:e.length==2?e[0]:null,host:e.length==2?e[1]:e[0]}}}function ae(n,e){let s=n.slice(0+1).trim(),o=s.indexOf(" ");return o===-1?(e.botCommand=s.slice(0),e.botCommandParams=""):(e.botCommand=s.slice(0,o),e.botCommandParams=s.slice(o).trim()),e}class ie{constructor(){this.events=new Map}on(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}emit(e,...t){this.events.has(e)&&this.events.get(e).forEach(s=>s(...t))}off(e,t){if(this.events.has(e)){const s=this.events.get(e),o=s.indexOf(t);o!==-1&&(s.splice(o,1),s.length===0&&this.events.delete(e))}}once(e,t){const s=(...o)=>{t(...o),this.off(e,s)};this.on(e,s)}}class ce extends ie{constructor({username:t,authToken:s,channel:o}){super();E(this,D);E(this,p,null);this.username=t.toLowerCase(),this.channel=`#${o.toLowerCase()}`,this.authToken=s}connect(t="ws://irc-ws.chat.twitch.tv:80"){v(this,p,new WebSocket(t)),u(this,p).onopen=()=>{u(this,p).send("CAP REQ :twitch.tv/tags twitch.tv/commands"),u(this,p).send(`PASS ${this.authToken}`),u(this,p).send(`NICK ${this.username}`),console.log("Authenticating with Twitch IRC server...")},u(this,p).onerror=s=>{console.error("Error connecting to Twitch IRC",s)},u(this,p).onmessage=s=>{w(this,D,K).call(this,s.data)},u(this,p).onclose=()=>{console.log("Disconnected from Twitch IRC")}}say(t,s){if(u(this,p).readyState===WebSocket.OPEN){const r=[s?`@reply-parent-msg-id=${s}`:"","PRIVMSG",this.channel,`:${t}`].join(" ").trim();u(this,p).send(r)}else console.error("Connection is not open")}close(){u(this,p)&&u(this,p).close()}}p=new WeakMap,D=new WeakSet,K=function(t){t.trim().split(`\r
`).forEach(o=>{const r=se(o);if(r)switch(r.command.command){case"PRIVMSG":if(r.parameters.startsWith("!")){const a=le(r);this.emit("command",a)}break;case"PING":u(this,p).send("PONG "+r.parameters);break;case"001":u(this,p).send(`JOIN ${this.channel}`);break;case"JOIN":console.log(`Joined ${this.channel}`);break;case"PART":console.log("The channel must have banned (/ban) the bot."),u(this,p).close();break;case"NOTICE":r.parameters==="Login authentication failed"?(console.log(`Authentication failed; left ${this.channel}`),u(this,p).send(`PART ${this.channel}`)):r.parameters==="You don't have permission to perform that action"&&(console.log(`No permission. Check if the access token is still valid. Left ${this.channel}`),u(this,p).send(`PART ${this.channel}`));break}})};function le(n){var e,t;return{user:n.tags["display-name"],command:n.command.botCommand,message:n.command.botCommandParams||"",flags:{broadcaster:!!((e=n.tags.badges)!=null&&e.broadcaster),mod:!!((t=n.tags.badges)!=null&&t.moderator)},extra:{userColor:n.tags.color,messageId:n.tags.id}}}function de(n){n.emit("command",{user:"adminUser",command:"clearList",message:"",flags:{broadcaster:!0,mod:!1},extra:{userColor:"#FF0000",messageId:`${q()}`}});const e=["red","coral","springGreen","lightSeaGreen","slateBlue","hotpink","violet","orange","darkTurquoise","dodgerblue","blueviolet"];for(let t=1;t<=8;t++){const s=`Username${t}`,o=e[t-1];for(let r=0;r<3;r++){const a={user:s,command:"taskadd",message:`test task description ${r===2?"with longer text for example":""}`,flags:{broadcaster:!0,mod:!1},extra:{userColor:o,messageId:`${q()}`}};setTimeout(()=>{n.emit("command",a)},1e3*t+r*100)}setTimeout(()=>{const r={user:s,command:"taskdone",message:"1",flags:{broadcaster:!0,mod:!1},extra:{userColor:o,messageId:`${q()}`}};n.emit("command",r)},1e3*t+1e4)}}function q(){return`${Math.floor(Math.random()*1e9)}`}const{auth:{twitch_channel:ue,twitch_oauth:me,twitch_username:he},settings:{testMode:R}}=configs,M=new ce({username:he,authToken:me,channel:ue});window.addEventListener("load",()=>{let n="userList";R&&(console.log("Test mode enabled"),n="testUserList");const e=new ee(n);e.render(),M.on("command",t=>{const{user:s,command:o,message:r,flags:a,extra:i}=t,c=e.chatHandler(s,o,r,a,i);c.error&&console.error(c.message),console.log(c.message),R||M.say(c.message,i.messageId)}),M.connect(),R&&de(M)})})();
